define(["ertoc/corsOverride","dojo/date","dojo/date/locale","dojo/store/Memory","dojo/request/registry","dojox/encoding/base64","dojo/Deferred","dojo/dom-style","dojo/dom","dijit/registry","dojox/mobile/ListItem","dojo/_base/json","dojo/promise/all","dojo/sniff"],function(n,t,i,r,u,f,e,o,s,h,c,l,a,v){"use strict";var y="//eatanddo.net/mobile/100/rest";return n(/eatanddo.net/),n(/cors-test.appspot.com/),window.app.data={currentUser:{userEmail:undefined,sessionGuid:undefined,authentication:undefined,authorization:undefined},server:{time:undefined,serverName:undefined,versionInformation:undefined},isFetching:!1,latestError:undefined,latestMessage:undefined,selectedWeek:undefined,selectedDay:undefined,selectedSearch:undefined,selectedMatch:undefined,selectedFood:undefined,selectedMealTime:undefined,selectedHistory:undefined,selectedFoodEntry:undefined,selectedMeasurementEntry:undefined,weeks:new r({idProperty:"weekDate"}),days:new r({idProperty:"dayDate"}),searches:new r({idProperty:"phrase"}),foods:new r({idProperty:"foodGuid"}),histories:new r({idProperty:"mealtime"}),foodTraces:new r({idProperty:"period"}),measurementTraces:new r({idProperty:"period"}),clear:function(){var n=window.app.data;n.currentUser.userEmail=undefined,n.currentUser.sessionGuid=undefined,n.currentUser.authentication=undefined,n.currentUser.authorization=undefined,n.latestError=undefined,n.latestMessage=undefined,n.selectedWeek=undefined,n.selectedDay=undefined,n.selectedSearch=undefined,n.selectedMatch=undefined,n.selectedFood=undefined,n.selectedMealTime=undefined,n.selectedHistory=undefined,n.selectedFoodEntry=undefined,n.selectedMeasurementEntry=undefined,n.weeks=new r({idProperty:"weekDate"}),n.days=new r({idProperty:"dayDate"}),n.searches=new r({idProperty:"phrase"}),n.foods=new r({idProperty:"foodGuid"}),n.histories=new r({idProperty:"mealtime"}),n.foodTraces=new r({idProperty:"period"}),n.measurementTraces=new r({idProperty:"period"})},startIndicator:function(n){var t=s.byId("imgLoading");t&&o.set(t,"display",""),window.app.data.logTransfer(n),app.display&&app.display.disableButtons(),app.data.isFetching=!0},stopIndicator:function(n){var t=s.byId("imgLoading");t&&o.set(t,"display","none"),window.app.data.logTransfer(n),app.display&&app.display.enableButtons(),app.data.isFetching=!1},logTransfer:function(n){if(window.app.showDebug===!0){var t=h.byId("listDataLog"),i=new Date,r=new c({rightText:i.getTime().toString().substr(6),variableHeight:!0,label:l.toJson(n)});t&&t.addChild(r)}},logError:function(n){window.app.showDebug&&window.alert(n),window.app.data.latestError=n,window.app.data.stopIndicator("ERROR "+n);throw n;},accessData:function(n,t,i){var r="http:";if(i||(i="GET"),t=!1,t===!0&&y.indexOf("localhost")===-1)if(v("ie")){if(!window.confirm('Because of a problem with the way Microsoft created Internet Explorer, we can not send your data over an encrypted channel to our server. Press "OK" if we can send your details UNENCRYPTED, or use another browser if you want your password encrypted. '))return}else r="https:";return window.app.data.startIndicator(r+y+n),u(r+y+n,{method:i,handleAs:"json",preventCache:!0,headers:{"X-Requested-With":null,Accept:"application/json, text/plain, */*"}}).then(function(n){return window.app.data.stopIndicator(n),n},window.app.data.logError)},checkVersion:function(){window.app.data.retreveVersion().then(function(){},function(n){window.alert(n)})},retreveVersion:function(){var n=window.app.data;return n.accessData("/ping",!1).then(function(t){if(t.length===1)n.server.time=t[0].time,n.server.serverName=t[0].serverName,n.server.versionInformation=t[0].versionInformation;else throw new Error;})},retreveUserAuthorization:function(n,t){var i=window.app.data,r=n+":"+t,u=r.getBytes(),e=f.encode(u);return i.currentUser.userEmail=n,i.currentUser.authentication=e,i.accessData("/authorizations/"+i.currentUser.authentication,!0).then(function(n){if(n.length===1)i.currentUser.sessionGuid=n[0].sessionGuid,i.currentUser.authorization=n[0].sessionGuid,i.currentUser.authorizationExpires=n[0].authorizationExpires,app.storeLocaly("sessionGuid",n[0].sessionGuid),app.storeLocaly("authorizationExpires",n[0].authorizationExpires);else throw new Error;})},retreveAnonymousAuthorization:function(){var n=window.app.data;return n.accessData("/authorizations/anonymous").then(function(t){if(t.length===1)n.currentUser.userEmail=t[0].message,n.currentUser.sessionGuid=t[0].sessionGuid,n.currentUser.authorization=t[0].sessionGuid,app.storeLocaly("sessionGuid",t[0].sessionGuid);else throw new Error;})},retrevePasswordResetStatus:function(n){var t=window.app.data,i=n+":",r=i.getBytes(),u=f.encode(r);return t.accessData("/passwordResets/"+u,!0,"POST").then(function(n){if(n.length===1)t.latestMessage=n[0].message;else throw new Error;})},register:function(n,t){var i=window.app.data,r=n+":"+t,u=r.getBytes(),e=f.encode(u);return i.accessData("/register/"+i.currentUser.authorization+"/"+e,!0,"POST").then(function(t){if(t.length===1)i.currentUser.userEmail=n;else throw new Error;})},denyAuthorization:function(){var n=window.app.data;return n.accessData("/denials/"+n.currentUser.authorization,!1,"POST").then(function(t){if(t.length===1)n.clear(),app.storeLocaly("sessionGuid","");else throw new Error;})},retreveSearch:function(n,t){var i=window.app.data,u=n.getBytes(),o=f.encode(u),r;return t===undefined&&(t=10),i.selectedSearch=undefined,i.searches.query({phrase:n}).forEach(function(n){i.selectedSearch=n}),i.selectedSearch!==undefined?(r=new e,r.resolve(i.selectedSearch),r):i.accessData("/matchDetails/"+o,{}).then(function(r){var f=!1,u;r.length<10&&(f=!0),u={phrase:n,maxCount:t,matches:r,hasNoMoreData:f},i.searches.add(u),i.selectedSearch=u})},retreveMoreSearchMatches:function(){var n=window.app.data,t,i;if(n.selectedSearch!==undefined)return t=n.selectedSearch.phrase.getBytes(),i=f.encode(t),n.selectedSearch.maxCount=n.selectedSearch.maxCount*2,n.accessData("/matchDetails/"+i+"/"+n.selectedSearch.maxCount,{}).then(function(t){t.length<n.selectedSearch.maxCount&&(n.selectedSearch.hasNoMoreData=!0),n.selectedSearch.matches=t})},retreveHistory:function(n){var t=window.app.data,r=10,i;return t.selectedHistory=undefined,n=n.toUpperCase(),t.histories.query({mealtime:n}).forEach(function(n){t.selectedHistory=n}),t.selectedHistory!==undefined?(i=new e,i.resolve(t.selectedHistory),i):t.accessData("/foodEntryHistory/"+t.currentUser.authorization+"/"+n+"/"+r).then(function(i){var u={mealtime:n,duration:r,entries:i,hasNoMoreData:!1};t.histories.add(u),t.selectedHistory=u})},retreveMoreHistoryEntries:function(){var n=window.app.data,t=100;if(n.selectedHistory!==undefined)return n.selectedHistory.duration=n.selectedHistory.duration*2,n.selectedHistory.duration>t&&(n.selectedHistory.duration=t),n.accessData("/foodEntryHistory/"+n.currentUser.authorization+"/"+n.selectedHistory.mealtime+"/"+n.selectedHistory.duration).then(function(t){t.length===n.selectedHistory.entries.length&&(n.selectedHistory.hasNoMoreData=!0),n.selectedHistory.entries=t})},retreveFood:function(n){var t=window.app.data,i;return t.selectedFood=undefined,t.foods.query({foodGuid:n}).forEach(function(n){t.selectedFood=n}),t.selectedFood!==undefined?(i=new e,i.resolve(t.selectedFood),i):t.accessData("/foodDetails/"+n,{}).then(function(n){if(n.length===1){var i=n[0];t.foods.add(i),t.selectedFood=i}})},retreveCurrentWeek:function(){var n=window.app.data,t=new Date,i=t.toISOString();return n.retreveWeek(i)},retrevePriorWeek:function(){var i=window.app.data,n=new Date(i.selectedWeek.weekDate),r;return n=t.add(n,"week",-1),r=n.toISOString(),i.retreveWeek(r)},retreveNextWeek:function(){var i=window.app.data,n=new Date(i.selectedWeek.weekDate),r;return n=t.add(n,"week",1),r=n.toISOString(),i.retreveWeek(r)},retreveWeek:function(n){var t=window.app.data,u=new Date(n),o=u.getDay()||7,r,f;return o!==1&&u.setHours(u.getHours()+-24*(o-1)),r=u.toISOString().substring(0,10),t.selectedWeek=undefined,t.weeks.query({weekDate:r}).forEach(function(n){t.selectedWeek=n}),t.selectedWeek!==undefined?(f=new e,f.resolve(t.selectedWeek),f):t.accessData("/daySummaries/"+t.currentUser.authorization+"/"+r).then(function(n){var f=new Date(r),e=i.format(f,{datePattern:"EEEE, d MMMM",selector:"date"}),u={weekDate:r,name:e,dailySummaries:n};t.weeks.add(u),t.selectedWeek=u})},retrevePriorDay:function(){var i=window.app.data,n=new Date(i.selectedDay.dayDate),r;return n=t.add(n,"day",-1),r=n.toISOString(),i.retreveDay(r)},retreveNextDay:function(){var i=window.app.data,n=new Date(i.selectedDay.dayDate),r;return n=t.add(n,"day",1),r=n.toISOString(),i.retreveDay(r)},retreveCurrentDay:function(){var n=window.app.data,t=new Date,i=t.toISOString();return n.retreveDay(i)},retreveYesterday:function(){var n=window.app.data,i=new Date,r=t.add(i,"day",-1),u=r.toISOString();return n.retreveDay(u)},retreveTommorow:function(){var n=window.app.data,i=new Date,r=t.add(i,"day",1),u=r.toISOString();return n.retreveDay(u)},retreveSelectedWeekDay:function(n){var r=window.app.data,i=new Date(r.selectedWeek.weekDate);return n.toLowerCase()==="monday"?i=t.add(i,"day",0):n.toLowerCase()==="tuesday"?i=t.add(i,"day",1):n.toLowerCase()==="wednesday"?i=t.add(i,"day",2):n.toLowerCase()==="thursday"?i=t.add(i,"day",3):n.toLowerCase()==="friday"?i=t.add(i,"day",4):n.toLowerCase()==="saturday"?i=t.add(i,"day",5):n.toLowerCase()==="sunday"&&(i=t.add(i,"day",6)),r.retreveDay(i.toISOString())},retreveDay:function(n){var t=window.app.data,r=n.substring(0,10),f,o,s;if(t.selectedDay=undefined,t.days.query({dayDate:r}).forEach(function(n){t.selectedDay=n}),t.selectedDay!==undefined)return f=new e,f.resolve(t.selectedDay),f;var h=new Date(r),c=i.format(h,{datePattern:"EEEE, d MMMM",selector:"date"}),u={dayDate:r,name:c,foodEntryDetails:null,measurementEntryDetails:null};return t.days.add(u),t.selectedDay=u,o=t.accessData("/foodEntryDetails/"+t.currentUser.authorization+"/"+r).then(function(n){u.foodEntryDetails=n}),s=t.accessData("/measurementEntryDetails/"+t.currentUser.authorization+"/"+r).then(function(n){u.measurementEntryDetails=n}),a([o,s])},storeFoodEntry:function(n,t,i,r,u){var f=window.app.data,e=r.substring(0,10),o=t.replace(" ","%20");return f.accessData("/foodEntry/"+f.currentUser.authorization+"/"+e+"/"+u+"?foodGuid="+i+"&amount="+n+"&unitName="+o,!1,"POST")},updateFoodEntry:function(n,t,i){var r=window.app.data,u=t.replace(" ","%20");return r.accessData("/foodEntry/"+r.currentUser.authorization+"/"+i+"?amount="+n+"&unitName="+u,!1,"POST")},updateMeasurementEntry:function(n,t,i,r){var e=window.app.data,o=i.replace(" ","%20"),f=n.split(":"),u=f[0].extractNumber()*60;return f[1].toLowerCase().indexOf("pm")>-1&&(u=u+720),u=u+f[1].extractNumber(),e.accessData("/measurementEntry/"+e.currentUser.authorization+"/"+r+"?minutes="+u+"&value="+t+"&unitName="+o,!1,"POST")},deleteFoodEntry:function(n){var t=window.app.data;return t.accessData("/foodEntry/"+t.currentUser.authorization+"/deleted/"+n,!1,"POST")},deleteMeasurementEntry:function(n){var t=window.app.data;return t.accessData("/measurementEntry/"+t.currentUser.authorization+"/deleted/"+n,!1,"POST")},storeMeasurementEntry:function(n,t,i,r,u){var o=window.app.data,s=r.substring(0,10),h=i.replace(" ","%20"),e=u.split(":"),f=e[0].extractNumber()*60;return e[1].toLowerCase().indexOf("pm")>-1&&(f=f+720),f=f+e[1].extractNumber(),o.accessData("/measurementEntry/"+o.currentUser.authorization+"/"+s+"/"+f+"?measurement="+n+"&value="+t+"&unitName="+h,!1,"POST")},updateEMail:function(n){var t=window.app.data,i=t.currentUser.userEmail.getBytes(),r=f.encode(i),u=n.getBytes(),e=f.encode(u);return t.accessData("/emailUpdate/"+t.currentUser.authorization+"?oldEmail="+r+"&newEmail="+e,!0,"POST")},updatePassword:function(n,t){var i=window.app.data,r=i.currentUser.userEmail.getBytes(),u=f.encode(r),e=n.getBytes(),o=f.encode(e),s=t.getBytes(),h=f.encode(s);return i.accessData("/passwordUpdate/"+i.currentUser.authorization+"?Email="+u+"&oldPassword="+o+"&newPassword="+h,!0,"POST")}},window.app.data})